<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Jogos - Trader Esportivo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-light">
  <div class="d-flex app-shell">
    <aside class="sidebar text-white p-4 d-flex flex-column gap-4">
      <div>
        <div class="brand-name">Trader<span>Esportivo</span></div>
        <p class="brand-tagline mb-0">Planejamento de bancas e entradas</p>
      </div>
      <nav class="nav flex-column nav-pills gap-2">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="agenda.html" class="nav-link">Jogos por dia</a>
        <a href="cadastro.html" class="nav-link active">Cadastrar jogos</a>
        <a href="selecionados.html" class="nav-link">Jogos selecionados</a>
        <a href="metodos.html" class="nav-link">Métodos</a>
      </nav>
      <div class="info-card">
        <h2 class="h6 mb-3">Boas práticas</h2>
        <ul class="mb-0 ps-3">
          <li>Revise a planilha antes de importar.</li>
          <li>Use nomes consistentes para as equipes.</li>
          <li>Atualize métodos de entrada com clareza.</li>
        </ul>
      </div>
    </aside>

    <main class="p-4 p-lg-5">
      <div class="container-fluid px-0">
        <header class="mb-4">
          <p class="page-subtitle mb-1">Gestão de base de jogos</p>
          <h1 class="page-title h3 mb-0">Cadastrar partidas via planilha CSV</h1>
        </header>

        <div class="row g-4 align-items-start">
          <div class="col-lg-7">
            <div class="card shadow-sm">
              <div class="card-body">
                <h2 class="h5 mb-3">Importar planilha</h2>
                <p class="text-secondary">Cole abaixo todo o conteúdo de um arquivo <strong>.csv</strong> com as informações do seu
                  planejamento. O texto enviado substituirá a base anterior para manter a lista de jogos sempre atualizada.</p>

                <div class="alert alert-info" role="alert">
                  <h3 class="h6 fw-semibold mb-2">Colunas obrigatórias</h3>
                  <ul class="mb-2 ps-3">
                    <li><code>Liga</code> e <code>País</code> para identificar a competição.</li>
                    <li><code>Horário</code> no formato 24h, ex.: <strong>16:30</strong>.</li>
                    <li><code>Casa</code> e <code>Visitante</code> para os times.</li>
                    <li><code>Odd Casa</code>, <code>Odd Visitante</code> e <code>Média Gols</code> para auxiliar na análise.</li>
                  </ul>
                  <p class="mb-0">Você pode adicionar colunas extras conforme a sua planilha. Todas elas aparecerão automaticamente nas telas.</p>
                </div>

                <form id="upload-form" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="match-date" class="form-label">Data dos jogos</label>
                    <input type="date" id="match-date" name="match-date" class="form-control" required />
                    <div class="form-text">Escolha o dia em que essas partidas serão disputadas.</div>
                  </div>
                  <div class="mb-3">
                    <label for="csv-input" class="form-label">Conteúdo da planilha CSV</label>
                    <textarea id="csv-input" name="csv" class="form-control" rows="12"
                      placeholder="Liga,País,Horário,Casa,Visitante,Odd Casa,Odd Visitante,Média Gols&#10;La Liga 2,ESP,16:30,Burgos,Castellón,2.42,2.95,2.4"
                      required></textarea>
                    <div class="form-text">Cada jogo deve estar em uma nova linha e os campos separados por vírgulas. O cabeçalho é opcional, mas obrigatório para colunas extras.</div>
                  </div>
                  <button type="submit" class="btn btn-primary">Enviar e salvar</button>
                </form>

                <div id="upload-result" class="alert d-none mt-3" role="alert"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body">
                <h2 class="h5 mb-2">Pré-visualização da estrutura</h2>
                <p class="text-secondary">Exemplo de conteúdo esperado:</p>
                <pre class="preview-block mb-3">Liga,País,Horário,Casa,Visitante,Odd Casa,Odd Visitante,Média Gols
La Liga 2,ESP,16:30,Burgos,Castellón,2.42,2.95,2.4
Liga Profesional de Fútbol,ARG,17:00,Gimnasia La Plata,Vélez Sarsfield,3.5,2.32,2.0
</pre>
                <p class="text-secondary mb-0">Os gols esperados e o método continuam sendo definidos no dashboard, apenas para os jogos marcados como selecionados.</p>
              </div>
            </div>
            <div class="card shadow-sm mt-4">
              <div class="card-body">
                <h2 class="h5 mb-2">Datas cadastradas</h2>
                <p id="dates-status" class="text-secondary small mb-3">Carregando datas...</p>
                <div class="list-group" id="dates-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const form = document.getElementById('upload-form');
    const resultBox = document.getElementById('upload-result');
    const submitButton = form.querySelector('button[type="submit"]');
    const csvInput = document.getElementById('csv-input');
    const matchDateInput = document.getElementById('match-date');
    const datesList = document.getElementById('dates-list');
    const datesStatus = document.getElementById('dates-status');

    function resetAlert() {
      resultBox.textContent = '';
      resultBox.className = 'alert d-none mt-3';
    }

    function formatShortDateLabel(dateString) {
      if (!dateString) {
        return 'Data não informada';
      }

      const date = new Date(`${dateString}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return dateString;
      }

      const weekday = new Intl.DateTimeFormat('pt-BR', { weekday: 'short' }).format(date).replace('.', '');
      const dayMonth = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit' }).format(date);
      return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} • ${dayMonth}`;
    }

    async function loadDates() {
      if (!datesList || !datesStatus) {
        return;
      }

      datesList.innerHTML = '';
      datesStatus.textContent = 'Carregando datas...';

      try {
        const response = await fetch('app.php?route=games/dates');
        const payload = await response.json();

        if (!response.ok) {
          throw new Error(payload.message || 'Erro ao carregar as datas.');
        }

        const dates = Array.isArray(payload.dates) ? payload.dates : [];

        if (!dates.length) {
          datesStatus.textContent = 'Nenhuma data cadastrada até o momento.';
          return;
        }

        datesStatus.textContent = 'Clique em uma data para revisar os jogos cadastrados.';

        const fragment = document.createDocumentFragment();
        dates.forEach((entry) => {
          if (!entry || !entry.date) {
            return;
          }

          const link = document.createElement('a');
          link.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          link.href = `agenda.html?date=${encodeURIComponent(entry.date)}`;

          const labelSpan = document.createElement('span');
          labelSpan.textContent = formatShortDateLabel(entry.date);

          const badge = document.createElement('span');
          badge.className = 'badge bg-primary rounded-pill';
          const totalValue = typeof entry.total === 'number' ? entry.total : parseInt(entry.total, 10);
          const sanitizedTotal = Number.isFinite(totalValue) ? totalValue : 0;
          badge.textContent = String(sanitizedTotal);

          link.appendChild(labelSpan);
          link.appendChild(badge);

          fragment.appendChild(link);
        });

        datesList.appendChild(fragment);
      } catch (error) {
        datesStatus.textContent = error.message || 'Erro inesperado ao carregar as datas cadastradas.';
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      resetAlert();

      const csvContent = csvInput.value.trim();
      const matchDateValue = matchDateInput.value;

      if (!matchDateValue) {
        resultBox.textContent = 'Selecione a data dos jogos antes de enviar.';
        resultBox.className = 'alert alert-danger mt-3';
        return;
      }

      if (csvContent === '') {
        resultBox.textContent = 'Cole o conteúdo do CSV antes de enviar.';
        resultBox.className = 'alert alert-danger mt-3';
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';

      try {
        const response = await fetch('app.php?route=upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ csv: csvContent, matchDate: matchDateValue }),
        });
        const payload = await response.json();

        if (response.ok) {
          resultBox.textContent = `Importação concluída! ${payload.inserted} jogo(s) foram salvos.`;
          resultBox.className = 'alert alert-success mt-3';
          form.reset();
          csvInput.value = '';
          await loadDates();
        } else {
          resultBox.textContent = payload.message || 'Não foi possível importar o conteúdo enviado.';
          resultBox.className = 'alert alert-danger mt-3';
        }
      } catch (error) {
        resultBox.textContent = 'Erro inesperado ao comunicar com o servidor. Tente novamente.';
        resultBox.className = 'alert alert-danger mt-3';
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enviar e salvar';
      }
    });

    loadDates();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
