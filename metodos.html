<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Métodos de Entrada - Trader Esportivo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-light">
  <div class="d-flex app-shell">
    <aside class="sidebar text-white p-4 d-flex flex-column gap-4">
      <div>
        <div class="brand-name">Trader<span>Esportivo</span></div>
        <p class="brand-tagline mb-0">Planejamento de bancas e entradas</p>
      </div>
      <nav class="nav flex-column nav-pills gap-2">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="cadastro.html" class="nav-link">Cadastrar jogos</a>
        <a href="selecionados.html" class="nav-link">Jogos selecionados</a>
        <a href="metodos.html" class="nav-link active">Métodos</a>
      </nav>
      <div class="info-card">
        <h2 class="h6 mb-3">Por que usar cores?</h2>
        <ul class="mb-0 ps-3">
          <li>Identifique rapidamente o tipo de entrada na tela de selecionados.</li>
          <li>Mantenha um padrão visual entre jogos com estratégias similares.</li>
          <li>Atualize as cores sempre que ajustar seu plano de trading.</li>
        </ul>
      </div>
    </aside>

    <main class="p-4 p-lg-5">
      <div class="container-fluid px-0">
        <header class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
          <div>
            <p class="page-subtitle mb-1">Gestão de estratégias</p>
            <h1 class="page-title h3 mb-2">Cadastro de métodos</h1>
            <p class="text-secondary mb-0">Defina os métodos que você utiliza nas partidas e atribua uma cor para facilitar a leitura nas outras páginas.</p>
          </div>
          <div>
            <a href="index.html" class="btn btn-outline-primary">Voltar ao dashboard</a>
          </div>
        </header>

        <div class="row g-4 align-items-start">
          <div class="col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h2 class="h5 mb-3">Novo método</h2>
                <p class="text-secondary">Informe um nome curto e escolha uma cor de destaque. Os métodos ficam disponíveis imediatamente para seleção nos jogos.</p>
                <form id="method-form" novalidate>
                  <div class="mb-3">
                    <label for="method-name" class="form-label">Nome do método</label>
                    <input type="text" id="method-name" class="form-control" name="name" placeholder="Ex.: Escanteios no fim" maxlength="60" required />
                  </div>
                  <div class="row g-3 mb-3">
                    <div class="col-sm-6">
                      <label for="method-color" class="form-label">Cor de identificação</label>
                      <input type="color" id="method-color" class="form-control form-control-color" name="color" value="#1D4ED8" title="Escolha uma cor" />
                    </div>
                    <div class="col-sm-6">
                      <label for="method-color-hex" class="form-label">Código hexadecimal</label>
                      <input type="text" id="method-color-hex" class="form-control" name="color_hex" value="#1D4ED8" maxlength="7" pattern="#[0-9a-fA-F]{6}" required />
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary">Salvar método</button>
                </form>
                <div id="method-feedback" class="alert d-none mt-3" role="alert"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <h2 class="h5 mb-2">Métodos cadastrados</h2>
                <p class="text-secondary">Veja todos os métodos registrados e suas cores associadas.</p>
                <div id="methods-list" class="methods-list list-group gap-3 mt-3">
                  <div class="empty-state">Nenhum método cadastrado. Adicione o primeiro para começar a usar nas partidas.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const form = document.getElementById('method-form');
    const nameInput = document.getElementById('method-name');
    const colorInput = document.getElementById('method-color');
    const colorHexInput = document.getElementById('method-color-hex');
    const feedbackBox = document.getElementById('method-feedback');
    const listContainer = document.getElementById('methods-list');
    const submitButton = form.querySelector('button[type="submit"]');

    function clearFeedback() {
      feedbackBox.textContent = '';
      feedbackBox.className = 'alert d-none mt-3';
    }

    function showFeedback(message, type) {
      feedbackBox.textContent = message;
      feedbackBox.className = `alert ${type === 'success' ? 'alert-success' : 'alert-danger'} mt-3`;
    }

    colorInput.addEventListener('input', () => {
      colorHexInput.value = colorInput.value.toUpperCase();
    });

    colorHexInput.addEventListener('input', () => {
      const value = colorHexInput.value.trim();
      if (/^#[0-9a-fA-F]{6}$/.test(value)) {
        colorInput.value = value.toUpperCase();
      }
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearFeedback();

      const name = nameInput.value.trim();
      const colorValue = normalizeHex(colorHexInput.value || colorInput.value);

      if (!name) {
        showFeedback('Informe o nome do método.', 'error');
        nameInput.focus();
        return;
      }

      if (!colorValue) {
        showFeedback('Escolha uma cor válida no formato hexadecimal.', 'error');
        colorHexInput.focus();
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Salvando...';

      try {
        const response = await fetch('app.php?route=methods', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, color: colorValue }),
        });

        const payload = await response.json();

        if (!response.ok) {
          throw new Error(payload.message || 'Não foi possível salvar o método.');
        }

        showFeedback('Método cadastrado com sucesso!', 'success');
        form.reset();
        colorInput.value = '#1D4ED8';
        colorHexInput.value = '#1D4ED8';
        await loadMethods();
      } catch (error) {
        showFeedback(error.message || 'Erro inesperado ao salvar o método.', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Salvar método';
      }
    });

    async function loadMethods() {
      listContainer.innerHTML = '<div class="empty-state">Carregando métodos...</div>';
      try {
        const response = await fetch('app.php?route=methods');
        if (!response.ok) {
          throw new Error('Não foi possível carregar os métodos.');
        }

        const payload = await response.json();
        const methods = Array.isArray(payload.methods) ? payload.methods : [];

        if (!methods.length) {
          listContainer.innerHTML = '<div class="empty-state">Nenhum método cadastrado. Adicione o primeiro para começar a usar nas partidas.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();
        methods.forEach((method) => {
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-center justify-content-between gap-3 shadow-sm';

          const info = document.createElement('div');
          info.className = 'd-flex flex-column';

          const title = document.createElement('strong');
          title.textContent = method.name;

          const hint = document.createElement('span');
          hint.className = 'text-secondary';
          hint.textContent = 'Disponível para seleção nos jogos.';

          info.appendChild(title);
          info.appendChild(hint);

          const badge = document.createElement('span');
          badge.className = 'method-color-chip';
          badge.style.backgroundColor = method.color;
          badge.style.borderColor = method.color;
          badge.textContent = method.color.toUpperCase();
          const readable = getReadableTextColor(method.color);
          if (readable) {
            badge.style.color = readable;
          }

          item.appendChild(info);
          item.appendChild(badge);
          fragment.appendChild(item);
        });

        listContainer.innerHTML = '';
        listContainer.appendChild(fragment);
      } catch (error) {
        listContainer.innerHTML = '<div class="empty-state">Erro ao carregar os métodos cadastrados.</div>';
        showFeedback(error.message || 'Erro ao carregar a lista.', 'error');
      }
    }

    function normalizeHex(value) {
      if (typeof value !== 'string') {
        return '';
      }
      let normalized = value.trim().toUpperCase();
      if (!normalized.startsWith('#')) {
        normalized = `#${normalized}`;
      }
      return /^#[0-9A-F]{6}$/.test(normalized) ? normalized : '';
    }

    function getReadableTextColor(hexColor) {
      if (typeof hexColor !== 'string') {
        return '';
      }

      const normalized = hexColor.trim().replace('#', '');

      if (normalized.length !== 6) {
        return '';
      }

      const r = Number.parseInt(normalized.slice(0, 2), 16);
      const g = Number.parseInt(normalized.slice(2, 4), 16);
      const b = Number.parseInt(normalized.slice(4, 6), 16);

      if ([r, g, b].some((value) => Number.isNaN(value))) {
        return '';
      }

      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.6 ? '#0f172a' : '#ffffff';
    }

    clearFeedback();
    loadMethods();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
