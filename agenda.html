<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jogos por Dia - Trader Esportivo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-light">
  <div class="d-flex app-shell">
    <aside class="sidebar text-white p-4 d-flex flex-column gap-4">
      <div>
        <div class="brand-name">Trader<span>Esportivo</span></div>
        <p class="brand-tagline mb-0">Planejamento de bancas e entradas</p>
      </div>
      <nav class="nav flex-column nav-pills gap-2">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="agenda.html" class="nav-link active">Jogos por dia</a>
        <a href="cadastro.html" class="nav-link">Cadastrar jogos</a>
        <a href="selecionados.html" class="nav-link">Jogos selecionados</a>
        <a href="metodos.html" class="nav-link">Métodos</a>
      </nav>
      <div class="info-card">
        <h2 class="h6 mb-3">Organização por data</h2>
        <ul class="mb-0 ps-3">
          <li>Cadastre uma data por envio de planilha.</li>
          <li>Revise cada agenda antes de definir os métodos.</li>
          <li>Use o dashboard para aplicar seleções rapidamente.</li>
        </ul>
      </div>
    </aside>

    <main class="p-4 p-lg-5">
      <div class="container-fluid px-0">
        <header class="mb-4">
          <p class="page-subtitle mb-1">Agenda diária dos jogos importados</p>
          <h1 id="selected-date-title" class="page-title h3 mb-2">Selecione uma data</h1>
          <p id="selected-date-subtitle" class="text-secondary mb-0">Escolha uma das datas cadastradas para visualizar os jogos correspondentes.</p>
        </header>

        <div class="row g-4">
          <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <h2 class="h5 mb-0">Datas disponíveis</h2>
                  <a href="cadastro.html" class="btn btn-sm btn-outline-primary">Cadastrar</a>
                </div>
                <p id="dates-status" class="text-secondary small mb-3">Carregando datas...</p>
                <div class="list-group" id="dates-list"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-8 col-xl-9">
            <div id="games-wrapper" class="d-flex flex-column gap-3">
              <div id="games-status" class="alert alert-info">Selecione uma data para listar os jogos cadastrados.</div>
              <div id="games-container" class="d-flex flex-column gap-3"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let currentDate = urlParams.get('date') || null;

    const dateTitle = document.getElementById('selected-date-title');
    const dateSubtitle = document.getElementById('selected-date-subtitle');
    const datesList = document.getElementById('dates-list');
    const datesStatus = document.getElementById('dates-status');
    const gamesStatus = document.getElementById('games-status');
    const gamesContainer = document.getElementById('games-container');

    function formatDateLabel(dateString) {
      if (!dateString) {
        return '';
      }

      const date = new Date(`${dateString}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return dateString;
      }

      const formatted = new Intl.DateTimeFormat('pt-BR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric',
      }).format(date);

      return formatted.charAt(0).toUpperCase() + formatted.slice(1);
    }

    function formatShortDateLabel(dateString) {
      if (!dateString) {
        return '';
      }
      const date = new Date(`${dateString}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return dateString;
      }

      const weekday = new Intl.DateTimeFormat('pt-BR', { weekday: 'short' }).format(date).replace('.', '');
      const dayMonth = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit' }).format(date);
      return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} • ${dayMonth}`;
    }

    function formatTimeLabel(timeValue) {
      if (!timeValue) {
        return 'Horário não informado';
      }
      const parts = String(timeValue).split(':');
      if (parts.length >= 2) {
        return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
      }
      return timeValue;
    }

    function updateHeader() {
      if (!currentDate) {
        dateTitle.textContent = 'Selecione uma data';
        dateSubtitle.textContent = 'Escolha uma das datas cadastradas para visualizar os jogos correspondentes.';
        return;
      }

      dateTitle.textContent = formatDateLabel(currentDate);
      dateSubtitle.textContent = '';
    }

    function setActiveDateItem(dateString) {
      const buttons = datesList.querySelectorAll('button[data-date]');
      buttons.forEach((button) => {
        if (button.dataset.date === dateString) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    function formatMatchLine(game) {
      const home = game.home_team || 'Time da casa';
      const away = game.away_team || 'Time visitante';
      return `${home} x ${away}`;
    }

    function createMethodBadge(game) {
      if (!game.selected || !game.method) {
        return null;
      }

      const badge = document.createElement('span');
      badge.className = 'badge-method';
      badge.textContent = game.method;
      if (game.method_color) {
        badge.style.backgroundColor = game.method_color;
        badge.style.color = '#fff';
      } else {
        badge.classList.add('bg-primary', 'text-white');
      }
      return badge;
    }

    function createGoalsBadge(game) {
      if (!game.selected || game.expected_goals === null || Number.isNaN(game.expected_goals)) {
        return null;
      }
      const badge = document.createElement('span');
      badge.className = 'badge-goals';
      badge.textContent = `xG: ${game.expected_goals.toFixed(2)}`;
      return badge;
    }

    function renderGamesList(games, headers) {
      gamesContainer.innerHTML = '';

      if (!games.length) {
        gamesStatus.className = 'alert alert-warning';
        gamesStatus.textContent = 'Nenhum jogo cadastrado para esta data.';
        return;
      }

      gamesStatus.className = 'alert alert-success';
      gamesStatus.textContent = `${games.length} jogo(s) cadastrados para esta data.`;

      const fragment = document.createDocumentFragment();

      games.forEach((game) => {
        const card = document.createElement('div');
        card.className = 'card shadow-sm';

        const body = document.createElement('div');
        body.className = 'card-body';

        const header = document.createElement('div');
        header.className = 'd-flex flex-wrap justify-content-between align-items-center gap-2 mb-2';

        const league = document.createElement('h3');
        league.className = 'h5 mb-0';
        league.textContent = game.league || 'Liga não informada';

        const timeBadge = document.createElement('span');
        timeBadge.className = 'badge text-bg-light';
        timeBadge.textContent = formatTimeLabel(game.match_time);

        header.appendChild(league);
        header.appendChild(timeBadge);
        body.appendChild(header);

        const matchLine = document.createElement('p');
        matchLine.className = 'fs-5 fw-semibold mb-3';
        matchLine.textContent = formatMatchLine(game);
        body.appendChild(matchLine);

        const badgesWrapper = document.createElement('div');
        badgesWrapper.className = 'd-flex flex-wrap gap-2 mb-3';
        const methodBadge = createMethodBadge(game);
        const goalsBadge = createGoalsBadge(game);

        if (methodBadge) {
          badgesWrapper.appendChild(methodBadge);
        }
        if (goalsBadge) {
          badgesWrapper.appendChild(goalsBadge);
        }

        if (badgesWrapper.children.length > 0) {
          body.appendChild(badgesWrapper);
        }

        const rawEntries = headers && headers.length
          ? headers.map((header) => [header, game.raw ? (game.raw[header] ?? '') : ''])
          : Object.entries(game.raw || {});

        if (rawEntries.length) {
          const details = document.createElement('dl');
          details.className = 'row row-cols-1 row-cols-md-2 g-3 small mb-0';

          rawEntries.forEach(([label, value]) => {
            const dt = document.createElement('dt');
            dt.className = 'col-md-4 text-secondary text-uppercase fw-semibold';
            dt.textContent = label;

            const dd = document.createElement('dd');
            dd.className = 'col-md-8 mb-0';
            dd.textContent = value !== null && value !== undefined && value !== '' ? String(value) : '—';

            details.appendChild(dt);
            details.appendChild(dd);
          });

          body.appendChild(details);
        }

        card.appendChild(body);
        fragment.appendChild(card);
      });

      gamesContainer.appendChild(fragment);
    }

    async function loadGamesForDate(dateString) {
      if (!dateString) {
        gamesContainer.innerHTML = '';
        gamesStatus.className = 'alert alert-info';
        gamesStatus.textContent = 'Selecione uma data para listar os jogos cadastrados.';
        return;
      }

      gamesContainer.innerHTML = '';
      gamesStatus.className = 'alert alert-info';
      gamesStatus.textContent = 'Carregando jogos...';

      try {
        const response = await fetch(`app.php?route=games&date=${encodeURIComponent(dateString)}`);
        const payload = await response.json();

        if (!response.ok) {
          throw new Error(payload.message || 'Erro ao carregar jogos.');
        }

        const games = Array.isArray(payload.games) ? payload.games : [];
        const headers = Array.isArray(payload.headers) ? payload.headers : [];
        renderGamesList(games, headers);
      } catch (error) {
        gamesContainer.innerHTML = '';
        gamesStatus.className = 'alert alert-danger';
        gamesStatus.textContent = error.message || 'Erro inesperado ao carregar os jogos.';
      }
    }

    async function loadDates() {
      datesList.innerHTML = '';
      datesStatus.textContent = 'Carregando datas...';

      try {
        const response = await fetch('app.php?route=games/dates');
        const payload = await response.json();

        if (!response.ok) {
          throw new Error(payload.message || 'Erro ao carregar as datas.');
        }

        const dates = Array.isArray(payload.dates) ? payload.dates : [];

        if (!dates.length) {
          datesStatus.textContent = 'Nenhuma data cadastrada até o momento. Importe novos jogos para começar.';
          currentDate = null;
          updateHeader();
          loadGamesForDate(null);
          return;
        }

        datesStatus.textContent = 'Clique em uma data para visualizar os jogos cadastrados.';

        const fragment = document.createDocumentFragment();
        let hasValidCurrentDate = false;

        dates.forEach((entry) => {
          if (!entry || !entry.date) {
            return;
          }
          const { date, total } = entry;
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          button.dataset.date = date;

          const labelSpan = document.createElement('span');
          labelSpan.textContent = formatShortDateLabel(date);

          const badge = document.createElement('span');
          badge.className = 'badge bg-primary rounded-pill';
          const totalValue = typeof total === 'number' ? total : parseInt(total, 10);
          const sanitizedTotal = Number.isFinite(totalValue) ? totalValue : 0;
          badge.textContent = String(sanitizedTotal);

          button.appendChild(labelSpan);
          button.appendChild(badge);
          button.addEventListener('click', () => {
            if (currentDate === date) {
              return;
            }
            currentDate = date;
            updateHeader();
            setActiveDateItem(date);
            loadGamesForDate(date);
            const newParams = new URLSearchParams(window.location.search);
            newParams.set('date', date);
            history.replaceState(null, '', `${window.location.pathname}?${newParams.toString()}`);
          });

          if (currentDate === date) {
            hasValidCurrentDate = true;
          }

          fragment.appendChild(button);
        });

        datesList.appendChild(fragment);

        if (!hasValidCurrentDate) {
          currentDate = dates[0].date;
        }

        updateHeader();
        setActiveDateItem(currentDate);
        loadGamesForDate(currentDate);
        const params = new URLSearchParams(window.location.search);
        params.set('date', currentDate);
        history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
      } catch (error) {
        datesStatus.textContent = error.message || 'Erro inesperado ao carregar as datas cadastradas.';
        currentDate = null;
        updateHeader();
        loadGamesForDate(null);
      }
    }

    updateHeader();
    loadDates();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
